#!/usr/bin/env python3
import argparse
import imaplib
import os
from getpass import getpass

ICLOUD_HOST = "imap.mail.me.com"
ICLOUD_PORT = 993


def main():
    parser = argparse.ArgumentParser(description="List iCloud IMAP mailboxes")
    parser.add_argument("--account", required=True, help="iCloud email account")
    args = parser.parse_args()

    icloud_pass = os.environ.get("ICLOUD_APP_PASSWORD")
    if not icloud_pass:
        icloud_pass = getpass(f"iCloud app password for {args.account}: ")

    m = imaplib.IMAP4_SSL(ICLOUD_HOST, ICLOUD_PORT)
    m.login(args.account, icloud_pass)
    typ, data = m.list()
    if typ != "OK":
        m.logout()
        raise SystemExit("Failed to list mailboxes")

    for line in data or []:
        try:
            print(line.decode("utf-8", errors="replace"))
        except Exception:
            print(line)

    m.logout()


if __name__ == "__main__":
    main()
